<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sparkseries.module.file.dao.FileMetadataMapper">

  <insert id="insertFile">
    INSERT INTO file_metadata (id, filename, original_name, file_type, file_size, storage_path,
                               last_update_date, storage_type)
    VALUES (#{file.id}, #{file.filename}, #{file.originalName}, #{file.fileType}, #{file.fileSize},
            #{file.storagePath}, #{file.lastUpdateDate}, #{file.storageType})
  </insert>

  <delete id="deleteFileById">
    DELETE
    FROM file_metadata
    WHERE id = #{id}
  </delete>
  <delete id="deleteFileByPath">
    DELETE
    FROM file_metadata
    WHERE storage_path like concat(#{path}, '%')
  </delete>

  <update id="updateFileNameAndPath">
    UPDATE file_metadata
    SET original_name = #{fileName},
        storage_path  = #{path}
    WHERE id = #{id}
  </update>

  <update id="updatePath">
    UPDATE file_metadata
    SET storage_path = #{path}
    WHERE id = #{id}
  </update>

  <update id="updateFileName">
    UPDATE file_metadata
    SET original_name = #{originalName},
        filename      = #{fileName}
    WHERE id = #{id}
  </update>

  <select id="isExistFileByName" resultType="java.lang.Integer">
    SELECT COUNT(*)
    FROM file_metadata
    WHERE original_name = #{name}
      and storage_path = #{path}
  </select>

  <select id="isExistFileById" resultType="java.lang.Integer">
    SELECT COUNT(*)
    FROM file_metadata
    WHERE id = #{id}
  </select>

  <select id="getFileMetadataById"
    resultType="com.sparkseries.module.file.entity.FileMetadataEntity">
    SELECT *
    FROM file_metadata
    WHERE id = #{id}
  </select>
  <select id="listLocalMetadataByPath"
    resultType="com.sparkseries.module.file.vo.FileInfoVO">
    SELECT id, original_name, file_size, last_update_date
    FROM file_metadata
    WHERE storage_path = #{path}
      and storage_type = 'LOCAL';
  </select>

  <select id="listOssMetadataByPath"
    resultType="com.sparkseries.module.file.vo.FileInfoVO">
    SELECT id, original_name, file_size, last_update_date
    FROM file_metadata
    WHERE storage_path = #{path}
      and storage_type = 'OSS';
  </select>

  <select id="listOssFolderByPath"
    resultType="java.lang.String">
    SELECT storage_path
    FROM file_metadata
    WHERE storage_path = concat(#{path}, '%')
      and storage_type = 'OSS';
  </select>

  <select id="listKodoMetadataByPath"
    resultType="com.sparkseries.module.file.vo.FileInfoVO">
    SELECT id, original_name, file_size, last_update_date
    FROM file_metadata
    WHERE storage_path = #{path}
      and storage_type = 'KODO';
  </select>

  <select id="listKodoFolderByPath"
    resultType="java.lang.String">
    SELECT storage_path
    FROM file_metadata
    WHERE storage_path = concat(#{path}, '%')
      and storage_type = 'KODO';
  </select>

  <select id="listCosMetadataByPath"
    resultType="com.sparkseries.module.file.vo.FileInfoVO">
    SELECT id, original_name, file_size, last_update_date
    FROM file_metadata
    WHERE storage_path = #{path}
      and storage_type = 'COS';
  </select>

  <select id="listCosFolderByPath"
    resultType="java.lang.String">
    SELECT storage_path
    FROM file_metadata
    WHERE storage_path = concat(#{path}, '%')
      and storage_type = 'COS';
  </select>

  <select id="listMinioMetadataByPath"
    resultType="com.sparkseries.module.file.vo.FileInfoVO">
    SELECT id, original_name, file_size, last_update_date
    FROM file_metadata
    WHERE storage_path = #{path}
      and storage_type = 'Minio';
  </select>

  <select id="listMinioFolderByPath"
    resultType="java.lang.String">
    SELECT storage_path
    FROM file_metadata
    WHERE storage_path = concat(#{path}, '%')
      and storage_type = 'Minio';
  </select>
</mapper>